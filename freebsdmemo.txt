TCP/IP协议

现在你知道所有的东西如何工作，让我们深入的考察一个真实的网络协议。
互联网协议中占统治地位的是TCP/IP协议，全称为“互联网协议上的传输控制协议”。
TCP是传输协议，而IP是网络协议。两者的联系是如此的紧密，以至于他们通常
被看作一个整体。我们从IP开始，然后考察TCP和UDP。

IP地址和网络掩码

IP地址是一个唯一的32位数字用于指定网络上的一个节点。某些IP地址，如重要的服务器地址，
会有一个相对较为固定的值。其他的，如电话线接入的客户端，则会根据网络的调度而变化。
在一个共享的网络上，每个的机器依次获得相邻的IP地址。

IP地址通常并不会使用32位的0和1来表达，而是分割成4个8位的数字，每个部分以10进制的
方式表现（如192.168.1.1），这样更利于我们记忆。

IP地址由ISP（网络服务供应商）以块为单位分配，这些块都很小，每块有16个或32个IP地址。
如果你的系统处于一个服务器群之中，就只能获得一个块中的少数的几个IP地址。

网络掩码是一个标签，表示本地网络的IP块的大小。IP块的大小决定了网络掩码，或者
网络掩码决定了你有多少IP地址。如果任意时长的网络，你会看到网络掩码为255.255.255.0，
并且知道它关联于一个256个IP地址的块。你可能还知道错误的掩码会让你的网络无法工作。
然而几天，这个简单的掩码正变得越来越小。要理解为什么，你需要知道一些有关IP地址的历史知识。
许多年前，IP地址被以3种级别大小的块为单位分配，A级块，B级块和C级块。这一术语至今已经有
超过10年的历史，我们仍以此为起点进行讨论。

A级块很简单，你的IP地址的四个数字中的头一个固定。发行机关（当时是InterNIC）会给你一个A级块，比如
10.0.0.0。你可以任意的指定后三个数字，但是你所有的IP地址对必须以10开头。例如你可以将10.1.0.0 到 10.1.1.255
分配给你的数据中心，10.1.2.0 到10.1.7.255分配给你的底特律办公室，等等。只有非常大的公司（如福特和施乐）和
有影响力的计算学院（如MIT），可以得到A级块。看到最初的A级块的主人的列表，就可以知道1980年代最有影响力的企业
都是那些。

B级块的IP地址的前两个数字固定。172.16.0.0就是一个B级块。你的每个IP地址都会以172.16开头，但是你可以任意的
指定后两个数字。许多中型企业都会得到B级块。

类似的C级块是前三个数字固定，这是为小型公司准备的，ISP会给你分配一个块如198.22.63.0，并让你指定最后一个数字。

这种方式浪费了很多IP，许多小公司不需要256个地址，许多中型企业需要的地址多过256个，但少于B级块的65535，而且几乎没有人
会需要A级块的1600万个地址。在互联网浪潮之前，这些选择方式足够好了，1980年代的时候孩子们会因为在电脑里乱搞而被
痛扁，但今天如果没有自己的电子商务站点也一样会被。这对IP地址的需求产生了压力。

今天的供应商以固定长度的方式分配IP地址，通常称为斜线（slash）方式。你会看到192.168.1.128/25的方式，看上去有些
令人糊涂，其实仅仅是一种更灵活的指定块级别的方式。你知道IP地址由四个8位长的十进制数组成，块级别实际上指定了有哪些位
的数字是固定的。A级块是8位，B级块是16位，C级块是24位。

总之，在网络里，你可以改变右边一些位的数字，而不能改变左边一些位的数字。唯一的问题是，“右边和左边的分界线在哪里”。
并不一定要把分界线放在8的倍数位置上，所以A/25意味着你有25位固定的数字，即比传统的C级块多一位固定位，你可以任意设定
之后的7位。你得到一个网络掩码设定固定位的值为1，可变位的值为0，对于上述例子中的/25地址段，子网掩码为：
11111111.11111111.11111111.10000000

11111111是255，10000000是128，所以你的子网掩码就是255.255.255.128。以二进制的角度看就很简单。

在实践中这意味着什么？首先，IP地址段都是以2的指数个为单位被分配，如果你有4个可变位，那就可以设置16个不同的IP地址，
如果你有8位可变，就可以设置256个IP地址。如果有人说他有19个IP地址，那么要么他把以太网分享给其他人，要么就是他错了。

一台主机的IP地址被附加上子网掩码的情况并不少见，如192.168.3.4/26，这包含了在局域网络中查找主机的全部信息。
（找到缺省的网关地址是另一个问题，但通常是地址段的开头或结尾）

以十进制计算网络掩码

不可用的IP地址

你已经知道斜线，掩码和IP地址指定如何工作，例如一个 /28 地址段有16个IP地址。不幸的是，你并不能使用
段里所有的IP地址，段的第一个IP地址是用于内部记录的网络数字（network number）。

类似的，地址段的最后一个地址是广播地址。根据IP协议，网络中的每台机器都要相应对该地址的请求。这允许
你通过ping广播地址并快速决定那个IP地址被使用了。例如对一个典型的/24网络，广播地址为x.y.z.255。而在1990
年代晚期，这一特性演变成了一项网络攻击的技巧。现在大多数的操作系统和网络设备缺省情况下都不允许这一特性。
如果你需要这项特性，可将sysctrl net.inet.icmp.bmcastecho设为1.

任何情况下，都无法为网络中的设备指定地址段的开头和结尾地址而不引发网络问题，有些系统失败的很优美，
有些系统则失败的不太优美。去找个时间试试吧，这样在你下一个工作的时候就会有一个好话题了。

关于Freebsd的邮件服务

邮件概述

大多数合法的邮件都来源于某个桌面系统上的用户，他们一般会使用
装有Outlook，Eudora，Thunderbird等的Windows或Mac系统。

客户端发送邮件到邮件服务器上————几乎每个公司或ISP（Internet Service Provider）
都有其专有的邮件服务器。为了保证邮件符合Internet标准，服务器对邮件进行一些基本的
合理性检查，然后查找负责收件地址的服务器。一旦找到收件服务器，它就会将邮件传送过去。
当收件人检查自己的邮件的时候，其客户端程序会登录邮件服务器并将新邮件下载到本地桌面上。
如果，收件人回信的话，整个过程就会逆转过来再进行一次。


查找一个域的邮件服务器

邮件服务器彼此间交换邮件，但他们如何找到对方？例如，我的个人邮件来自域名blackhelicopter.org，
如果我写了一封邮件给freebsd.org的用户，我的邮件服务器怎样找到freebsd.org的邮件服务器？

每个域通过DNS发布邮件交换（Mail eXchange, MX）记录，我们在第14章曾提到过MX记录（没有MX记录，email
就会退化成灵活性少很多的A记录）。一个接收邮件的域的DNS记录会包含一条或多条MX记录，每条MX记录会
带有一个设定值的数字。我们通过MX查询查找freebsd.org的邮件交换机：

# dig freebsd.org mx
...
;; QUESTION SECTION:
;freebsd.org. IN MX
;; ANSWER SECTION:
freebsd.org. 381 IN MX 10 mx1.freebsd.org.

freebsd.org仅有一个MX服务器，具有设定值10。所有发送给freebsd.org的邮件都会通过mx1.freebsd.org。将这
一结果与大型商务公司比较:

# dig cnn.com mx
...
;; QUESTION SECTION:
;cnn.com. IN MX

;; ANSWER SECTION:
 cnn.com. 3600 IN MX 30 lonmail1.turner.com.
 cnn.com. 3600 IN MX 40 hkgmail1.turner.com.
 cnn.com. 3600 IN MX 10 atlmail3.turner.com.
 cnn.com. 3600 IN MX 10 atlmail5.turner.com.
 cnn.com. 3600 IN MX 20 nycmail1.turner.com.
 cnn.com. 3600 IN MX 20 nycmail2.turner.com.

CNN有六个邮件交换机，两个具有优先值10(最低的数字)，所以发往cnn.com的邮件会首先尝试发送给atlmail3.turner.com或atlmail5.turner.com。
如过该服务器掉线的话，会再尝试优先值20的服务器nycmail1.turner.com和nycmail2.turner.com。如果优先值10和20的服务器都掉线了的话，会再
一次尝试优先值30和40的服务器。

维护单一的MX记录是逐渐流行的反垃圾邮件的手法，如果你的域有一个有效的DNS，发送方将连日来的邮件排队。结果备份的邮件交换机不知道域的
哪个收件人有效，使它成为接受垃圾的第一候选。许多反垃圾工具使用备份的MX作为域中的路由，虽然之前我曾提到每个域都应该有多个MX主机，但是
这正变得困难不考虑你与垃圾邮件作斗争的时间


无法发送的邮件

当邮件服务器找到一个域的邮件交换机，但所有的邮件交换机都不接受邮件是，邮件服务器会在队列里放置一条消息。每个15分钟，服务器会重新尝试
传送该邮件。互联网标准允许花5天时间传送一条消息，如果无法做到，会返回一条消息到发送方。

如果邮件服务器无法找到域中的任何MX记录，并且也找不到与域名相同的主机记录，则会立刻返回一条消息给发送方。用户会问你为什么他的完全有效的
邮件被拒绝了，然后你就可以告诉他yahoo.com不是以Q开头的。

这两种错误完全不同，邮件发送者因此会有不同的体验。这也是为什么远离第一名字服务器的地方最好有第二名字服务器的原因之一。这样当你的第一名字服务器
和邮件交换机挂掉了，邮件仍然可以在服务恢复的时候传送给你。